<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ISS Spotter ¬∑ Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Inter:wght@300;400;500&display=swap" rel="stylesheet">

  <!-- Dashboard CSS -->
  <link rel="stylesheet" href="./css/dashboard.css" />
</head>

<body>

  <!-- ‚≠ê Stars -->
  <div id="star-container"></div>

  <!-- üîù Header -->
  <div class="header">
    <div class="header-left">
      <div class="title">ISS SPOTTER</div>
    </div>

    <img
      id="profileAvatar"
      class="profile-avatar"
      onclick="window.location.href='profile.html'"
    />
  </div>


<!-- üß© ISS WIDGETS CONTAINER -->
<div class="iss-widgets-container">

  <!-- üõ∞ NEXT ISS PASS WIDGET -->
  <div class="iss-pass-widget floating-card" id="issPassWidget">
    <div class="widget-title">ISS SPOTTER</div>

    <div class="pass-status" id="passStatus">
      Calculating next visible pass‚Ä¶
    </div>

    <div class="pass-details hidden" id="passDetails">
      <div class="row">
        <span>Date</span>
        <strong id="passDate">‚Äî</strong>
      </div>
      <div class="row">
        <span>Time</span>
        <strong id="passTime">‚Äî</strong>
      </div>
      <div class="row">
        <span>Duration</span>
        <strong id="passDuration">‚Äî</strong>
      </div>
      <div class="row">
        <span>Max Elevation</span>
        <strong id="passElevation">‚Äî</strong>
      </div>
    </div>
  </div>

  <!-- üõ∞ ISS LIVE INFO WIDGET -->
  <div class="iss-pass-widget floating-card" id="issLiveWidget">
    <div class="widget-title">ISS LIVE STATUS</div>

    <div class="pass-details">
      <div class="row">
        <span>Latitude</span>
        <strong id="issLat">‚Äî</strong>
      </div>
      <div class="row">
        <span>Longitude</span>
        <strong id="issLon">‚Äî</strong>
      </div>
      <div class="row">
        <span>Altitude</span>
        <strong id="issAlt">‚Äî km</strong>
      </div>
      <div class="row">
        <span>Velocity</span>
        <strong id="issVel">‚Äî km/h</strong>
      </div>
    </div>
  </div>

</div>


  <!-- üó∫ Map -->
  <div id="map"></div>

  <!-- ‚Ñπ Footer -->
  <div class="footer-note">
    <div>
        v2.0
    </div>
  </div>

  <!-- üåç LOCATION SETUP MODAL -->
  <div id="locationModal" class="modal-overlay hidden">
    <div class="modal-card">

      <div class="modal-header">
        <h2>Set your location</h2>
        <span id="closeModal" class="close-btn">‚úï</span>
      </div>

      <p class="modal-text">
        We use your location only to calculate when the ISS will be visible
        from your sky. Your location is never tracked continuously.
      </p>

      <!-- City search -->
      <div class="modal-section">
        <label>Search city or place</label>
        <input
          type="text"
          id="cityInput"
          placeholder="e.g. Mumbai, London, New York"
        />
        <div id="cityResults" class="city-results"></div>
      </div>

      <!-- Divider -->
      <div class="divider">OR</div>

      <!-- Browser location -->
      <button id="useLocationBtn" class="primary-btn">
        üìç Use my current location
      </button>

      <!-- Advanced -->
      <details class="advanced">
        <summary>Advanced: enter coordinates manually</summary>
        <div class="coord-inputs">
          <input id="latInput" type="number" step="any" placeholder="Latitude">
          <input id="lonInput" type="number" step="any" placeholder="Longitude">
        </div>
        <button id="saveCoordsBtn" class="secondary-btn">
          Save coordinates
        </button>
      </details>

    </div>
  </div>

  <!-- Leaflet -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/satellite.js/dist/satellite.min.js"></script>

  

  <!-- ISS Map -->
  <script type="module" src="./js/iss-map.js"></script>

  <!-- ‚≠ê Stars -->
  <script>
    const starContainer = document.getElementById("star-container");
    for (let i = 0; i < 160; i++) {
      const star = document.createElement("div");
      star.className = "star";
      const size = Math.random() * 1.5 + 0.5;
      star.style.width = star.style.height = `${size}px`;
      star.style.left = `${Math.random() * 100}%`;
      star.style.top = `${Math.random() * 100}%`;
      star.style.animationDuration = `${Math.random() * 7 + 5}s`;
      star.style.animationDelay = `${Math.random() * 7}s`;
      starContainer.appendChild(star);
    }
  </script>

  <!-- üîê Auth + Location Setup Logic -->
  <script type="module">
    import { auth, db } from "./js/firebase-init.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const modal = document.getElementById("locationModal");
    const closeBtn = document.getElementById("closeModal");
    const avatar = document.getElementById("profileAvatar");

    const cityInput = document.getElementById("cityInput");
    const cityResults = document.getElementById("cityResults");
    const useLocationBtn = document.getElementById("useLocationBtn");
    const saveCoordsBtn = document.getElementById("saveCoordsBtn");

    let currentUser = null;

    onAuthStateChanged(auth, async (user) => {
      if (!user) return location.replace("login.html");
      
        const token = await user.getIdToken(true);

        const res = await fetch(
            "https://us-central1-iss-spotter-6c8ba.cloudfunctions.net/computeNextVisiblePass",
            {
            method: "POST",
            headers: {
                "Authorization": `Bearer ${token}`
            }
            }
        );

        const data = await res.json();
        console.log("Next pass result:", data);



      currentUser = user;
      avatar.src = user.photoURL || "";

      const ref = doc(db, "users", user.uid);
      const snap = await getDoc(ref);

      if (!snap.exists() || !snap.data().location) {
        modal.classList.remove("hidden");
      }
    });

    closeBtn.onclick = () => {
      // user can close but dashboard remains blocked visually
      modal.classList.add("hidden");
    };

    // üìç Browser location
    useLocationBtn.onclick = () => {
      navigator.geolocation.getCurrentPosition(async pos => {
        await saveLocation(pos.coords.latitude, pos.coords.longitude);
      });
    };

    // üî¢ Manual coords
    saveCoordsBtn.onclick = async () => {
      const lat = parseFloat(document.getElementById("latInput").value);
      const lon = parseFloat(document.getElementById("lonInput").value);
      if (!isNaN(lat) && !isNaN(lon)) {
        await saveLocation(lat, lon);
      }
    };

    async function saveLocation(lat, lon) {
      await setDoc(doc(db, "users", currentUser.uid), {
        location: { lat, lon },
        locationSet: true,
        locationUpdatedAt: serverTimestamp()
      }, { merge: true });

      modal.classList.add("hidden");
      location.reload(); // safe reload AFTER location exists

      await loadNextIssPass(true);
    }

    // üåç City search (Nominatim)
    let searchTimeout;
    cityInput.addEventListener("input", () => {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(searchCity, 400);
    });

    async function searchCity() {
      const q = cityInput.value.trim();
      if (!q) return cityResults.innerHTML = "";

      const res = await fetch(
        `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(q)}&format=json&limit=5`
      );
      const data = await res.json();

      cityResults.innerHTML = "";
      data.forEach(place => {
        const div = document.createElement("div");
        div.className = "city-item";
        div.textContent = place.display_name;
        div.onclick = () => saveLocation(
          parseFloat(place.lat),
          parseFloat(place.lon)
        );
        cityResults.appendChild(div);
      });
    }




const passStatus = document.getElementById("passStatus");
const passDetails = document.getElementById("passDetails");

const passDate = document.getElementById("passDate");
const passTime = document.getElementById("passTime");
const passDuration = document.getElementById("passDuration");
const passElevation = document.getElementById("passElevation");

// üîí Cooldown = 3 hours
const PASS_COOLDOWN_MS = 3 * 60 * 60 * 1000;

function renderPassFromFirestore(nextPass) {
  const start = nextPass.startTime.toDate();
  const end = nextPass.endTime.toDate();

  passStatus.textContent = "Next ISS pass visible from your location";
  passDetails.classList.remove("hidden");

  passDate.textContent = start.toDateString();
  passTime.textContent =
    `${start.toLocaleTimeString()} ‚Äì ${end.toLocaleTimeString()}`;
  passDuration.textContent =
    `${Math.round(nextPass.durationSec)} seconds`;
  passElevation.textContent =
    `${Number(nextPass.maxElevationDeg).toFixed(1)}¬∞`;
}

function renderPassFromBackend(pass) {
  const start = new Date(pass.startTime);
  const end = new Date(pass.endTime);

  passStatus.textContent = "Next ISS pass visible from your location";
  passDetails.classList.remove("hidden");

  passDate.textContent = start.toDateString();
  passTime.textContent =
    `${start.toLocaleTimeString()} ‚Äì ${end.toLocaleTimeString()}`;
  passDuration.textContent =
    `${Math.round(pass.durationSec)} seconds`;
  passElevation.textContent =
    `${pass.maxElevationDeg.toFixed(1)}¬∞`;
}

async function loadNextIssPass(force = false) {
  try {
    passStatus.textContent = "Checking saved pass‚Ä¶";
    passDetails.classList.add("hidden");

    const user = auth.currentUser;
    if (!user) return;

    // 1) Always check Firestore first
    const userRef = doc(db, "users", user.uid);
    const snap = await getDoc(userRef);

    if (snap.exists()) {
      const userData = snap.data();
      const nextPass = userData?.nextPass;
      const computedAt = nextPass?.nextPassComputedAt;

      // If we have valid saved pass
      if (nextPass && computedAt && nextPass.startTime && nextPass.endTime) {
        const computedAtMs = computedAt.toMillis();
        const ageMs = Date.now() - computedAtMs;

        // ‚úÖ If within 3 hours AND not forced -> show cached only (NO backend call)
        if (!force && ageMs < PASS_COOLDOWN_MS) {
          renderPassFromFirestore(nextPass);
          return;
        }
      }
    }

    // 2) Only reach here if:
    // - force === true (location updated)
    // OR
    // - no pass exists in Firestore
    // OR
    // - pass is older than 3 hours
    passStatus.textContent = "Calculating next visible pass‚Ä¶";
    passDetails.classList.add("hidden");

    const token = await user.getIdToken(true);

    const res = await fetch(
      "https://us-central1-iss-spotter-6c8ba.cloudfunctions.net/computeNextVisiblePass",
      {
        method: "POST",
        headers: {
          Authorization: `Bearer ${token}`
        }
      }
    );

    const data = await res.json();

    if (data.status !== "ok") {
      passStatus.textContent = "No visible ISS pass in the next 72 hours.";
      return;
    }

    renderPassFromBackend(data.nextPass);

  } catch (err) {
    console.error(err);
    passStatus.textContent = "Failed to compute ISS visibility.";
  }
}

// Initial load (safe, won't recalc if <3h old)
onAuthStateChanged(auth, (user) => {
  if (user) loadNextIssPass(false);
});


const ISS_LIVE_API =
  "https://us-central1-iss-spotter-6c8ba.cloudfunctions.net/getIssLivePublic";

const issLat = document.getElementById("issLat");
const issLon = document.getElementById("issLon");
const issAlt = document.getElementById("issAlt");
const issVel = document.getElementById("issVel");

async function updateIssLiveWidget() {
  try {
    const res = await fetch(ISS_LIVE_API);
    const data = await res.json();

    if (data.status !== "ok") return;

    issLat.textContent = data.latitude.toFixed(4);
    issLon.textContent = data.longitude.toFixed(4);
    issAlt.textContent = `${data.altitude.toFixed(1)} km`;
    issVel.textContent = `${data.velocity.toFixed(0)} km/h | ${((data.velocity)/3600).toFixed(2)} km/s`;
  } catch (err) {
    console.error("ISS live widget fetch failed:", err);
  }
}

// Run once + refresh every 5s
updateIssLiveWidget();
setInterval(updateIssLiveWidget, 5000);



  </script>

</body>
</html>
