<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ISS Spotter ¬∑ Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Inter:wght@300;400;500&display=swap" rel="stylesheet">

  <!-- Dashboard CSS -->
  <link rel="stylesheet" href="./css/dashboard.css" />
</head>

<body>

  <!-- ‚≠ê Stars -->
  <div id="star-container"></div>

  <!-- üîù Header -->
  <div class="header">
    <div class="header-left">
      <div class="title">ISS SPOTTER</div>
      <div class="pass-info">
        Next visible pass: <strong>Calculating‚Ä¶</strong>
      </div>
      <button class="notify-btn">Keep me posted</button>
    </div>

    <img
      id="profileAvatar"
      class="profile-avatar"
      onclick="window.location.href='profile.html'"
    />
  </div>

  <!-- üó∫ Map -->
  <div id="map"></div>

  <!-- ‚Ñπ Footer -->
  <div class="footer-note">
    <div>    Next visible pass feature is currently under development.
    We‚Äôll notify you once it‚Äôs live.</div>
    <div>
        v1.1.1
    </div>
  </div>

  <!-- üåç LOCATION SETUP MODAL -->
  <div id="locationModal" class="modal-overlay hidden">
    <div class="modal-card">

      <div class="modal-header">
        <h2>Set your location</h2>
        <span id="closeModal" class="close-btn">‚úï</span>
      </div>

      <p class="modal-text">
        We use your location only to calculate when the ISS will be visible
        from your sky. Your location is never tracked continuously.
      </p>

      <!-- City search -->
      <div class="modal-section">
        <label>Search city or place</label>
        <input
          type="text"
          id="cityInput"
          placeholder="e.g. Mumbai, London, New York"
        />
        <div id="cityResults" class="city-results"></div>
      </div>

      <!-- Divider -->
      <div class="divider">OR</div>

      <!-- Browser location -->
      <button id="useLocationBtn" class="primary-btn">
        üìç Use my current location
      </button>

      <!-- Advanced -->
      <details class="advanced">
        <summary>Advanced: enter coordinates manually</summary>
        <div class="coord-inputs">
          <input id="latInput" type="number" step="any" placeholder="Latitude">
          <input id="lonInput" type="number" step="any" placeholder="Longitude">
        </div>
        <button id="saveCoordsBtn" class="secondary-btn">
          Save coordinates
        </button>
      </details>

    </div>
  </div>

  <!-- Leaflet -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- ISS Map -->
  <script type="module" src="./js/iss-map.js"></script>

  <!-- ‚≠ê Stars -->
  <script>
    const starContainer = document.getElementById("star-container");
    for (let i = 0; i < 160; i++) {
      const star = document.createElement("div");
      star.className = "star";
      const size = Math.random() * 1.5 + 0.5;
      star.style.width = star.style.height = `${size}px`;
      star.style.left = `${Math.random() * 100}%`;
      star.style.top = `${Math.random() * 100}%`;
      star.style.animationDuration = `${Math.random() * 7 + 5}s`;
      star.style.animationDelay = `${Math.random() * 7}s`;
      starContainer.appendChild(star);
    }
  </script>

  <!-- üîê Auth + Location Setup Logic -->
  <script type="module">
    import { auth, db } from "./js/firebase-init.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const modal = document.getElementById("locationModal");
    const closeBtn = document.getElementById("closeModal");
    const avatar = document.getElementById("profileAvatar");

    const cityInput = document.getElementById("cityInput");
    const cityResults = document.getElementById("cityResults");
    const useLocationBtn = document.getElementById("useLocationBtn");
    const saveCoordsBtn = document.getElementById("saveCoordsBtn");

    let currentUser = null;

    onAuthStateChanged(auth, async (user) => {
      if (!user) return location.replace("login.html");
      currentUser = user;
      avatar.src = user.photoURL || "";

      const ref = doc(db, "users", user.uid);
      const snap = await getDoc(ref);

      if (!snap.exists() || !snap.data().location) {
        modal.classList.remove("hidden");
      }
    });

    closeBtn.onclick = () => {
      // user can close but dashboard remains blocked visually
      modal.classList.add("hidden");
    };

    // üìç Browser location
    useLocationBtn.onclick = () => {
      navigator.geolocation.getCurrentPosition(async pos => {
        await saveLocation(pos.coords.latitude, pos.coords.longitude);
      });
    };

    // üî¢ Manual coords
    saveCoordsBtn.onclick = async () => {
      const lat = parseFloat(document.getElementById("latInput").value);
      const lon = parseFloat(document.getElementById("lonInput").value);
      if (!isNaN(lat) && !isNaN(lon)) {
        await saveLocation(lat, lon);
      }
    };

    async function saveLocation(lat, lon) {
      await setDoc(doc(db, "users", currentUser.uid), {
        location: { lat, lon },
        locationSet: true,
        locationUpdatedAt: serverTimestamp()
      }, { merge: true });

      modal.classList.add("hidden");
      location.reload(); // safe reload AFTER location exists
    }

    // üåç City search (Nominatim)
    let searchTimeout;
    cityInput.addEventListener("input", () => {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(searchCity, 400);
    });

    async function searchCity() {
      const q = cityInput.value.trim();
      if (!q) return cityResults.innerHTML = "";

      const res = await fetch(
        `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(q)}&format=json&limit=5`
      );
      const data = await res.json();

      cityResults.innerHTML = "";
      data.forEach(place => {
        const div = document.createElement("div");
        div.className = "city-item";
        div.textContent = place.display_name;
        div.onclick = () => saveLocation(
          parseFloat(place.lat),
          parseFloat(place.lon)
        );
        cityResults.appendChild(div);
      });
    }
  </script>

</body>
</html>
