<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>ISS Spotter ¬∑ Profile</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Inter:wght@300;400;500&display=swap" rel="stylesheet">


<link rel="stylesheet" href="./css/profile.css" />

</head>

<body>

<!-- ‚≠ê Stars -->
<div id="star-container"></div>

<div class="container">
  <div class="back" onclick="location.href='dashboard.html'">‚Üê Back to dashboard</div>

  <!-- USER -->
  <div class="header">
    <img id="avatar" class="avatar" />
    <div id="name" class="name"></div>
    <div id="email" class="email"></div>
  </div>

  <!-- LOCATION -->
  <div class="section">
    <h3>Location</h3>
    <div class="card">
      <div id="locationText">Loading‚Ä¶</div>
      <button id="openLocationModal">Update location</button>
    </div>
  </div>

  <!-- NOTIFICATIONS -->
  <div class="section">
    <h3>Notifications</h3>
    <div class="card toggle">
      <span>Email me when ISS is visible</span>
      <input type="checkbox" id="notifyToggle">
    </div>
    <div style="font-size:12px;margin-top:8px;opacity:.85">
      Email feature is currently under development.
      We‚Äôll notify you once it‚Äôs live.
    </div>
  </div>

  <!-- PRIVACY -->
<div class="section">
  <h3>Privacy & Data Usage</h3>
  <div class="card">
    ISS Spotter is designed with minimal data collection, transparency,
    and full user control. Below is a detailed explanation of how your data
    is handled.
    <br><br>

    <strong>What we store:</strong><br>
    ‚Ä¢ Your Google display name and email address (for authentication and communication)<br>
    ‚Ä¢ The last location you provide (latitude and longitude), used only to calculate ISS visibility<br>
    ‚Ä¢ Your notification preference (whether you choose to receive emails or not)<br>
    <br>

    <strong>How location is provided:</strong><br>
    ‚Ä¢ You may allow browser-based location access, search for a city or place, or manually enter coordinates<br>
    ‚Ä¢ Granting browser location permission is optional and not required to use the application<br>
    ‚Ä¢ Only the most recent location you provide is stored<br>
    ‚Ä¢ We do not collect location history and do not track movement over time<br>
    <br>

    <strong>Email communications:</strong><br>
    ‚Ä¢ If enabled, emails are sent on days when the ISS is expected to be visible from your saved location<br>
    ‚Ä¢ Emails may also be sent to inform you about new versions, feature releases, or important updates to the application<br>
    ‚Ä¢ All emails are plain text only<br>
    ‚Ä¢ No sponsored, promotional, marketing, or third-party content is ever included<br>
    ‚Ä¢ You may disable email notifications at any time from your profile<br>
    <br>

    <strong>What we do NOT do:</strong><br>
    ‚Ä¢ We do not track you in real time<br>
    ‚Ä¢ We do not continuously access your location<br>
    ‚Ä¢ We do not access your contacts, files, or browsing activity<br>
    ‚Ä¢ We do not sell, share, or monetize your data in any form<br>
    ‚Ä¢ We do not use third-party analytics or profiling tools<br>
    <br>

    <strong>Your control:</strong><br>
    You remain in full control of your data at all times.
    You may update or delete your stored location, delete your saved user data,
    or permanently delete your account whenever you choose.
  </div>
</div>


  <!-- ACCOUNT -->
  <div class="section">
    <h3>Account</h3>
    <button onclick="logout()">Log out</button>
    <br>
    <button onclick="deleteUserData()">Delete my data</button>
    <br>
    <button class="danger" onclick="deleteAccount()">Delete my account</button>
  </div>
</div>


  <!-- ‚Ñπ Footer -->
  <div class="footer-note">
    <div>
        v2.0
    </div>
  </div>



<!-- üåç LOCATION MODAL -->
<div id="locationModal" class="modal-overlay hidden">
  <div class="modal-card">

    <div class="modal-header">
      <h2>Update your location</h2>
      <span id="closeModal" class="close-btn">‚úï</span>
    </div>

    <p class="modal-text">
      Update your location to improve ISS visibility predictions.
      We store only your last provided location.
    </p>

    <!-- City search -->
    <div class="modal-section">
      <label>Search city or place</label>
      <input id="cityInput" placeholder="e.g. Mumbai, London">
      <div id="cityResults" class="city-results"></div>
    </div>

    <div class="divider">OR</div>

    <button id="useLocationBtn" class="primary-btn">
      üìç Use my current location
    </button>

    <details class="advanced">
      <summary>Advanced: enter coordinates manually</summary>
      <div class="coord-inputs">
        <input id="latInput" type="number" step="any" placeholder="Latitude">
        <input id="lonInput" type="number" step="any" placeholder="Longitude">
      </div>
      <button id="saveCoordsBtn" class="secondary-btn">
        Save coordinates
      </button>
    </details>

  </div>
</div>



<!-- ‚≠ê Star generation (SAME AS LOGIN) -->
<script>
const starContainer = document.getElementById("star-container");

for (let i = 0; i < 160; i++) {
  const star = document.createElement("div");
  star.className = "star";
  const size = Math.random() * 1.5 + 0.5;
  star.style.width = `${size}px`;
  star.style.height = `${size}px`;
  star.style.left = `${Math.random() * 100}%`;
  star.style.top = `${Math.random() * 100}%`;
  star.style.animationDuration = `${Math.random() * 7 + 5}s`;
  star.style.animationDelay = `${Math.random() * 7}s`;
  starContainer.appendChild(star);
}
</script>

<script type="module">
import { auth, db } from "./js/firebase-init.js";
import {
  onAuthStateChanged,
  signOut,
  deleteUser
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

import {
  doc,
  getDoc,
  setDoc,
  deleteDoc,
  deleteField,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

let currentUser;

const modal = document.getElementById("locationModal");
document.getElementById("openLocationModal").onclick =
  () => modal.classList.remove("hidden");
document.getElementById("closeModal").onclick =
  () => modal.classList.add("hidden");

onAuthStateChanged(auth, async (user) => {
  if (!user) return location.replace("login.html");
  currentUser = user;

  document.getElementById("avatar").src = user.photoURL;
  document.getElementById("name").textContent = user.displayName;
  document.getElementById("email").textContent = user.email;

  const ref = doc(db, "users", user.uid);
  const snap = await getDoc(ref);

  if (snap.exists()) {
    const d = snap.data();
    document.getElementById("locationText").textContent =
      d.location
        ? `Lat: ${d.location.lat}, Lon: ${d.location.lon}`
        : "Location not set";
    document.getElementById("notifyToggle").checked = !!d.notifyByEmail;
  }
});

async function saveLocation(lat, lon) {
  await setDoc(doc(db, "users", currentUser.uid), {
    location: { lat, lon },
    locationUpdatedAt: serverTimestamp(),
    locationSet: true
  }, { merge: true });
  modal.classList.add("hidden");
  location.reload();
  await loadNextIssPass(true);
}

useLocationBtn.onclick = () => {
  navigator.geolocation.getCurrentPosition(pos =>
    saveLocation(pos.coords.latitude, pos.coords.longitude)
  );
};

saveCoordsBtn.onclick = () => {
  const lat = parseFloat(latInput.value);
  const lon = parseFloat(lonInput.value);
  if (!isNaN(lat) && !isNaN(lon)) saveLocation(lat, lon);
};

let t;
cityInput.addEventListener("input", () => {
  clearTimeout(t);
  t = setTimeout(async () => {
    if (!cityInput.value) return cityResults.innerHTML = "";
    const res = await fetch(
      `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(cityInput.value)}&format=json&limit=5`
    );
    const data = await res.json();
    cityResults.innerHTML = "";
    data.forEach(p => {
      const div = document.createElement("div");
      div.className = "city-item";
      div.textContent = p.display_name;
      div.onclick = () => saveLocation(+p.lat, +p.lon);
      cityResults.appendChild(div);
    });
  }, 400);
});





document.getElementById("notifyToggle").addEventListener("change", async e => {
  await setDoc(doc(db, "users", currentUser.uid), {
    notifyByEmail: e.target.checked
  }, { merge: true });
});

window.deleteUserData = async () => {
  if (!confirm("This will delete your saved location and notification preferences. Continue?")) return;

  const userRef = doc(db, "users", currentUser.uid);

  await setDoc(userRef, {
    location: deleteField(),          // ‚ùå remove location
    locationSet: false,               // üîÅ reset onboarding
    notifyByEmail: false,              // üîÅ reset preference
    locationUpdatedAt: serverTimestamp(),
    updatedAt: serverTimestamp()
  }, {merge: true}); 

  alert("Your saved location and preferences have been deleted.");
  location.reload();
};

window.logout = async () => {
  await signOut(auth);
  location.replace("login.html");
};

window.deleteAccount = async () => {
  if (!confirm("This will permanently delete your account and all associated data. This cannot be undone. Continue?")) return;
  await deleteDoc(doc(db, "users", currentUser.uid));
  await deleteUser(currentUser);
  location.replace("login.html");
};
</script>

</body>
</html>
